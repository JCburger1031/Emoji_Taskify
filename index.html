<script>
  const input = document.getElementById('taskInput');
  const list = document.getElementById('taskList');
  const addBtn = document.getElementById('addBtn');

  const totalCount = document.getElementById('totalCount');
  const completedCount = document.getElementById('completedCount');
  const deletedCountEl = document.getElementById('deletedCount');
  const editedCountEl = document.getElementById('editedCount');

  let tasks = JSON.parse(localStorage.getItem('tasks')) || [];
  let deletedCount = 0;
  let editedCount = 0;

  // ✅ snapshot of original order (NO DUPES)
  let originalOrder = tasks.map(t => ({ ...t }));

  function save() {
    localStorage.setItem('tasks', JSON.stringify(tasks));
  }

  function updateCounters() {
    totalCount.textContent = tasks.length;
    completedCount.textContent = tasks.filter(t => t.completed).length;
    deletedCountEl.textContent = deletedCount;
    editedCountEl.textContent = editedCount;
  }

  function render() {
    list.innerHTML = '';

    tasks.forEach(task => {
      const li = document.createElement('li');
      if (task.completed) li.classList.add('completed');

      const checkbox = document.createElement('input');
      checkbox.type = 'checkbox';
      checkbox.checked = task.completed;
      checkbox.onchange = () => {
        task.completed = checkbox.checked;
        save();
        render();
      };

      const span = document.createElement('span');
      span.textContent = task.text;
      span.className = 'text';
      span.ondblclick = () => editTask(task.id, span);

      const del = document.createElement('button');
      del.textContent = '✖';
      del.onclick = () => {
        if (confirm(`Delete task: ${task.text}?`)) {
          tasks = tasks.filter(t => t.id !== task.id);
          originalOrder = originalOrder.filter(t => t.id !== task.id);
          deletedCount++;
          save();
          render();
        }
      };

      li.append(checkbox, span, del);
      list.appendChild(li);
    });

    updateCounters();
  }

  function addTask() {
    const text = input.value.trim();
    if (!text) return alert('Empty task');

    if (tasks.some(t => t.text.toLowerCase() === text.toLowerCase()))
      return alert('Duplicate task');

    const newTask = {
      id: Date.now(),   // ✅ stable ID (fixes reset/delete bugs)
      text,
      completed: false
    };

    tasks.push(newTask);
    originalOrder.push({ ...newTask });

    input.value = '';
    save();
    render();
  }

  function editTask(id, span) {
    const task = tasks.find(t => t.id === id);

    const editInput = document.createElement('input');
    editInput.type = 'text';
    editInput.value = task.text;

    span.replaceWith(editInput);
    editInput.focus();

    function saveEdit() {
      const val = editInput.value.trim();
      if (!val) return alert('Empty task');

      if (tasks.some(t => t.id !== id && t.text.toLowerCase() === val.toLowerCase()))
        return alert('Duplicate task');

      task.text = val;
      originalOrder.find(t => t.id === id).text = val;

      editedCount++;
      save();
      render();
    }

    editInput.onblur = saveEdit;
    editInput.onkeydown = e => e.key === 'Enter' && saveEdit();
  }

  addBtn.onclick = addTask;
  input.onkeydown = e => e.key === 'Enter' && addTask();

  document.getElementById('sortAsc').onclick = () => {
    tasks.sort((a, b) => a.text.localeCompare(b.text));
    render();
  };

  document.getElementById('sortDesc').onclick = () => {
    tasks.sort((a, b) => b.text.localeCompare(a.text));
    render();
  };

  // ✅ FIXED RESET (NO DUPLICATES + SAVES)
  document.getElementById('resetSort').onclick = () => {
    tasks = originalOrder.map(t => ({ ...t }));
    save();
    render();
  };

  document.getElementById('themeToggle').onclick = () => {
    document.body.classList.toggle('dark');
  };

  render();
</script>
